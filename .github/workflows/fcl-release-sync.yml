name: FCL Release Sync to WebDAV

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时运行一次
  workflow_dispatch:  # 支持手动触发

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Python dependencies
      run: |
        pip3 install requests
        
    - name: Get all FCL releases
      id: get-releases
      run: |
        # 获取所有发布版信息
        ALL_RELEASES=$(curl -s "https://api.github.com/repos/FCL-Team/FoldCraftLauncher/releases")
        
        # 提取所有标签名称
        TAG_NAMES=$(echo "$ALL_RELEASES" | grep '"tag_name":' | cut -d '"' -f 4)
        
        echo "tag_names=$TAG_NAMES" >> $GITHUB_OUTPUT
        
        # 下载所有版本的文件
        echo "$TAG_NAMES" | while read tag; do
          if [ ! -z "$tag" ]; then
            echo "Processing release: $tag"
            
            # 获取发布信息
            RELEASE_INFO=$(curl -s "https://api.github.com/repos/FCL-Team/FoldCraftLauncher/releases/tags/$tag")
            RELEASE_BODY=$(echo "$RELEASE_INFO" | grep '"body":' | cut -d '"' -f 4)
            
            # 下载Linux版本
            ASSET_URL=$(echo "$RELEASE_INFO" | grep '"browser_download_url":' | grep -E 'linux|amd64' | head -1 | cut -d '"' -f 4)
            if [ ! -z "$ASSET_URL" ]; then
              curl -L -o "FoldCraftLauncher-$tag.AppImage" "$ASSET_URL"
              echo "Downloaded: FoldCraftLauncher-$tag.AppImage"
            fi
            
            # 下载Windows版本
            ASSET_URL_WIN=$(echo "$RELEASE_INFO" | grep '"browser_download_url":' | grep -E 'windows|exe' | head -1 | cut -d '"' -f 4)
            if [ ! -z "$ASSET_URL_WIN" ]; then
              curl -L -o "FoldCraftLauncher-$tag.exe" "$ASSET_URL_WIN"
              echo "Downloaded: FoldCraftLauncher-$tag.exe"
            fi
            
            # 保存发布说明
            echo "$RELEASE_BODY" > "release_notes_$tag.md"
          fi
        done
        
    - name: Run sync script
      env:
        WEBDAV_USERNAME: ${{ secrets.WEBDAV_USERNAME }}
        WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
        WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      run: |
        python3 sync_webdav.py
        
    - name: Cleanup
      if: always()
      run: |
        # 清理下载的文件
        rm -f "FoldCraftLauncher-*.AppImage" "FoldCraftLauncher-*.exe" "release_notes_*.md" sync_webdav.py